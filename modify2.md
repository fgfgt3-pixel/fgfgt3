time	stock_code	current_price	volume	ma5	rsi14	disparity	stoch_k	stoch_d	vol_ratio	z_vol	obv_delta	spread	bid_ask_imbalance	accel_delta	ret_1s	ask1	ask2	ask3	ask4	ask5	bid1	bid2	bid3	bid4	bid5	ask1_qty	ask2_qty	ask3_qty	ask4_qty	ask5_qty	bid1_qty	bid2_qty	bid3_qty	bid4_qty	bid5_qty	indiv_net_vol	foreign_net_vol	inst_net_vol	pension_net_vol	trust_net_vol	insurance_net_vol	private_fund_net_vol	bank_net_vol	state_net_vol	other_net_vol	prog_net_vol
124926730	5930	70050	5138112	70050	50	100	50	50	1	0	0	100	0	0	0	0	0	0	0	0	0	0	0	0	0	39871	208669	79756	0	0	339724	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926741	5930	70100	5138113	70075	50	100.0356761	50	50	1.000000097	0	5138113	100	0	0	0	0	0	0	0	0	0	0	0	0	0	39871	208669	79756	0	0	339724	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926743	5930	70100	5138117	70083.33333	50	100.0237812	50	50	1.000000584	0	0	100	0	-50	0	0	0	0	0	0	0	0	0	0	0	39871	208669	79756	0	0	339724	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926744	5930	70100	5138118	70087.5	50	100.0178348	50	50	1.000000584	0	0	100	0	0	0	0	0	0	0	0	0	0	0	0	0	39871	208669	79756	0	0	339724	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926746	5930	70100	5138119	70090	50	100.0142674	50	50	1.000000623	0	0	100	0	0	0	0	0	0	0	0	0	0	0	0	0	39871	208669	79756	0	0	339724	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926757	5930	70050	5138129	70090	50	99.94293052	50	50	1.000002141	0	-5138129	100	0	-50	0	0	0	0	0	0	0	0	0	0	0	39866	208669	79756	0	0	339425	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926758	5930	70050	5138144	70080	50	99.95719178	50	50	1.000004337	0	0	100	0	50	0	0	0	0	0	0	0	0	0	0	0	39866	208669	79756	0	0	339425	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926759	5930	70050	5138154	70070	50	99.97145711	50	50	1.000005498	0	0	100	0	0	0	0	0	0	0	0	0	0	0	0	0	39866	208669	79756	0	0	339425	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926769	5930	70100	5138299	70070	50	100.0428143	50	50	1.000029972	0	5138299	100	0	50	0	0	0	0	0	0	0	0	0	0	0	39864	208669	79756	0	0	339437	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926770	5930	70100	5138306	70070	50	100.0428143	50	50	1.000028201	2.01551737	0	100	0	-50	0	0	0	0	0	0	0	0	0	0	0	39864	208669	79756	0	0	339437	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926784	5930	70100	5138309	70080	50	100.0285388	50	50	1.000026168	1.666879157	0	100	0	0	0	0	0	0	0	0	0	0	0	0	0	39619	208669	79756	0	0	339430	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124926785	5930	70050	5138357	70080	50	99.95719178	50	50	1.00003255	1.813314457	-5138357	100	0	-50	0	0	0	0	0	0	0	0	0	0	0	39619	208669	79756	0	0	339430	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124927027	5930	70100	5138362	70090	50	100.0142674	50	50	1.000030945	1.593226487	5138362	100	0	100	0	0	0	0	0	0	0	0	0	0	0	39709	208669	79756	0	0	339729	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124927433	5930	70050	5138376	70080	50	99.95719178	30	50	1.000031264	1.515685522	-5138376	100	0	-100	0	0	0	0	0	0	0	0	0	0	0	39704	208669	79756	0	0	339729	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124928131	5930	70100	5138377	70080	57.14285714	100.0285388	40	50	1.000029362	1.37094222	5138377	100	0	100	0	0	0	0	0	0	0	0	0	0	0	39704	208669	79756	0	0	339735	240733	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124929038	5930	70050	5138420	70070	42.85714286	99.97145711	30	33.33333333	1.000035372	1.561053007	-5138420	100	0	-100	0	0	0	0	0	0	0	0	0	0	0	39703	208669	79756	0	0	339430	240758	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124929333	5930	70100	5138421	70080	50	100.0285388	40	36.66666667	1.000033474	1.42313814	5138421	100	0	100	0	0	0	0	0	0	0	0	0	0	0	39703	208669	79756	0	0	339430	240758	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124930535	5930	70100	5139421	70080	50	100.0285388	40	36.66666667	1.000215419	3.777396731	0	100	0	-50	0	0	0	0	0	0	0	0	0	0	0	39702	208669	79756	0	0	339430	240758	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124931640	5930	70050	5139426	70080	44.44444444	99.95719178	30	36.66666667	1.000205	2.785649484	-5139426	100	0	-50	-0.071326676	0	0	0	0	0	0	0	0	0	0	38797	208669	79756	0	0	339404	240788	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124932435	5930	70100	5139466	70080	55.55555556	100.0285388	40	36.66666667	1.000202144	2.366647458	5139466	100	0	100	0	0	0	0	0	0	0	0	0	0	0	38797	208669	79756	0	0	339409	240787	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124933227	5930	70050	5139470	70080	50	99.95719178	30	33.33333333	1.000189705	2.058335311	-5139470	100	0	-100	0	0	0	0	0	0	0	0	0	0	0	38757	208669	79756	0	0	339289	240787	158242	0	0	0	0	0	0	0	0	0	0	0	0	0
124933347	5930	70100	5139473	70080	54.54545455	100.0285388	40	36.66666667	1.000177053	1.846157493	5139473	100	0	100	0.071377587	0	0	0	0	0	0	0	0	0	0	38757	208669	79756	0	0	339289	240787	158242	0	0	0	0	0	0	0	0	0	0	0	0	0

# 문제점 분석 (modify2.md)

## 현재 상황
- 호가 데이터 파싱은 성공: 로그에서 `FID 41 (ask1): 70200`, `FID 51 (bid1): 70100` 등 정상 확인됨
- 호가 데이터 저장도 성공: `🏦 [호가저장]` 메시지로 확인됨  
- **하지만 CSV에는 모든 호가 가격이 0.0으로 저장됨**

## 핵심 문제
1. **데이터 흐름 단절**: 호가 이벤트에서 저장 → 체결 이벤트에서 병합 → CSV 저장 과정에서 데이터 손실
2. **병합 실패**: `latest_orderbook`에 저장된 데이터가 `update_tick_data()` 함수로 전달될 때 손실
3. **타이밍 문제**: 호가 이벤트와 체결 이벤트 사이의 시간차로 인한 데이터 덮어쓰기

## 해결 방안
### 방안 1: 강제로 모든 이벤트를 CSV에 저장 (테스트 중)
- 호가 전용 이벤트도 CSV 저장하여 데이터 보존
- 장점: 데이터 손실 없음
- 단점: 중복 데이터 발생 가능

### 방안 2: 호가 데이터를 indicator 계산 시점에 강제 주입
- `_calculate_all_indicators()` 함수에서 강제로 호가 데이터 주입
- 현재 시도: `tick_data`에서 직접 추출하도록 수정

### 방안 3: CSV Writer에서 호가 데이터 보정
- CSV 저장 직전에 `latest_orderbook` 데이터를 강제로 병합

## 시도한 해결 방안들 (모두 실패)

### ✅ 1. 호가 파싱 확인
- **상태**: 성공
- **확인**: 로그에서 `FID 41 (ask1): 70200`, `FID 51 (bid1): 70100` 정상 확인됨
- **결론**: 키움 API에서 데이터는 정상적으로 받아오고 있음

### ✅ 2. latest_orderbook 저장 확인  
- **상태**: 성공
- **확인**: `🏦 [호가저장] 005930: ask1=70200, bid1=70100` 메시지 정상 출력
- **결론**: 메모리 저장소에는 정상적으로 저장되고 있음

### ❌ 3. 데이터 병합 로직 수정
- **시도**: 호가 이벤트와 체결 이벤트 분리 처리 → 체결 시점에 병합
- **결과**: 병합 로그는 성공적으로 나타나지만 CSV에는 0.0으로 저장됨

### ❌ 4. 지표 계산 로직 수정  
- **시도**: `_calculate_all_indicators()` 함수에서 `tick_data`에서 직접 호가 추출
- **결과**: 여전히 CSV에 0.0으로 저장됨

### ❌ 5. CSV Writer 보정 로직 추가
- **시도**: `write_indicators()` 함수에서 0인 값들을 `latest_orderbook` 데이터로 교체
- **결과**: 여전히 CSV에 0.0으로 저장됨

### ❌ 6. 비상 조치: 모든 이벤트 CSV 저장
- **시도**: 호가 전용 이벤트도 가상 가격을 생성해서 모든 데이터를 CSV에 저장
- **결과**: 여전히 CSV에 0.0으로 저장됨

## 🚨 심각한 문제 확인 

### 추정되는 근본 원인
1. **데이터 타입 변환 문제**: 어딘가에서 호가 데이터가 0으로 변환되고 있음
2. **메모리 덮어쓰기**: 다른 프로세스에서 데이터를 0으로 초기화하고 있음  
3. **스레드 동기화 문제**: 멀티 스레드 환경에서 데이터 경합 발생
4. **CSV 헤더 미스매치**: CSV 헤더와 실제 데이터 키가 일치하지 않음

### 권장 차세대 접근법
1. **단순 테스트**: 호가 데이터만 별도 CSV로 저장하는 간단한 테스트
2. **직접 디버깅**: CSV writer에서 실제로 받은 값을 raw 로그로 출력
3. **동기화 강화**: 모든 호가 관련 작업을 단일 스레드에서 처리
4. **타입 검증 강화**: 모든 단계에서 데이터 타입과 값을 검증

## 현재 상황
- **호가 파싱**: ✅ 성공 (70200, 70100 등 정상값 확인됨)
- **메모리 저장**: ✅ 성공 (latest_orderbook에 정상 저장됨)  
- **CSV 출력**: ❌ 실패 (모든 호가 가격이 0.0으로 저장됨)

**결론**: 데이터 흐름의 마지막 단계인 CSV 저장 과정에서 문제 발생
